name: Daily Learning with Discord

on:
  schedule:
    - cron: '7 1 * * *'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  generate-and-notify:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v3
      
    - name: Generate daily report
      env:
        CLAUDE_API_KEY: ${{ secrets.CLAUDE_API_KEY }}
      run: |
        mkdir -p reports
        python scripts/generate_report.py
        echo "TODAY=$(date +'%Y-%m-%d')" >> $GITHUB_ENV
      
    - name: Commit report
      uses: stefanzweifel/git-auto-commit-action@v4
      with:
        commit_message: '📚 학습 리포트 - ${{ env.TODAY }}'
        file_pattern: 'reports/*.md'
        
    - name: Send to Discord
      env:
        DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
      run: |
        # 디스코드 웹훅으로 알림 전송
        curl -H "Content-Type: application/json" \
             -X POST \
             -d '{
               "embeds": [{
                 "title": "📚 새로운 학습 자료가 준비되었습니다!",
                 "description": "오늘의 언리얼 엔진 학습 주제를 확인해보세요.",
                 "color": 3447003,
                 "fields": [
                   {
                     "name": "📅 날짜",
                     "value": "'$TODAY'",
                     "inline": true
                   },
                   {
                     "name": "🔗 리포트 링크",
                     "value": "https://github.com/'${{ github.repository }}'/blob/main/reports/today.md"
                   }
                 ],
                 "footer": {
                   "text": "궁금한 점이 있으면 !질문 명령어를 사용하세요!"
                 }
               }]
             }' \
             $DISCORD_WEBHOOK_URL
